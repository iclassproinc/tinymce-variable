tinymce.PluginManager.add("variable",function(editor){var mapper=editor.getParam("variable_mapper",{});var valid=editor.getParam("variable_valid",null);var className=editor.getParam("variable_class","variable");var prefix=editor.getParam("variable_prefix","{{");var suffix=editor.getParam("variable_suffix","}}");var allowInvalid=editor.getParam("variable_allow_invalid",false);var replacebadVar=editor.getParam("replace_bad_variable",null);var typedCharacters="";function getStringVariableRegex(){RegExp.escape=function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")};return new RegExp(RegExp.escape(prefix)+"([a-zA-Z0-9._ \\u00C0-\\u017F]*)?"+RegExp.escape(suffix),"g")}function isValid(name){if(!valid||valid.length===0)return true;var validString="|"+valid.join("|").toLowerCase()+"|";return validString.indexOf("|"+name.toLowerCase()+"|")>-1?true:false}function getMappedValue(cleanValue){if(typeof mapper==="function")return mapper(cleanValue);return mapper.hasOwnProperty(cleanValue)?mapper[cleanValue]:cleanValue}function cleanVariable(value){return value.replace(/[^a-zA-Z0-9._\s\u00C0-\u017F]/g,"")}function createHTMLVariable(value){var cleanValue=cleanVariable(value);var invalid=false;if(!isValid(cleanValue)){if(allowInvalid){invalid=true}else{return value}}var cleanMappedValue=getMappedValue(cleanValue);editor.fire("variableToHTML",{value:value,cleanValue:cleanValue});var variable=prefix+cleanValue+suffix;if(replacebadVar&&invalid){cleanMappedValue=replacebadVar}return'<span class="'+className+(invalid?"-bad":"")+'" data-original-variable="'+variable+'" contenteditable="false">'+cleanMappedValue+"</span>"}function stringToHTML(){var nodeList=[],nodeValue,node,div;tinymce.walk(editor.getBody(),function(n){if(n.nodeType==3&&n.nodeValue&&getStringVariableRegex().test(n.nodeValue)){nodeList.push(n)}},"childNodes");for(var i=0;i<nodeList.length;i++){nodeValue=nodeList[i].nodeValue.replace(getStringVariableRegex(),createHTMLVariable);div=editor.dom.create("div",null,nodeValue);while(node=div.lastChild){editor.dom.insertAfter(node,nodeList[i])}editor.dom.remove(nodeList[i])}}function htmlToString(){var nodeList=[],nodeValue,node,div;tinymce.walk(editor.getBody(),function(n){if(n.nodeType==1){var original=n.getAttribute("data-original-variable");if(original!==null){nodeList.push(n)}}},"childNodes");for(var i=0;i<nodeList.length;i++){nodeValue=nodeList[i].getAttribute("data-original-variable");div=editor.dom.create("div",null,nodeValue);while(node=div.lastChild){editor.dom.insertAfter(node,nodeList[i])}editor.dom.remove(nodeList[i])}}function handleContentRerender(e){return e.format==="raw"?stringToHTML():htmlToString()}function addVariable(value){var htmlVariable=createHTMLVariable(value);var cursorPosition=editor.selection.getRng();editor.execCommand("mceInsertContent",false,htmlVariable);if(cursorPosition){var elements=editor.dom.select('span[data-original-variable="'+prefix+cleanVariable(value)+suffix+'"]');if(elements.length>0){var newNode=elements[elements.length-1];cursorPosition.setStartAfter(newNode);cursorPosition.collapse(true);editor.selection.setRng(cursorPosition)}}editor.focus()}function isVariable(element){if(typeof element.getAttribute==="function"&&element.hasAttribute("data-original-variable"))return true;return false}function handleClick(e){var target=e.target;if(!isVariable(target))return null;if(e.target.nextSibling){editor.selection.setCursorLocation(e.target.nextSibling)}else{editor.selection.select(e.target);editor.selection.collapse()}var value=target.getAttribute("data-original-variable");editor.fire("variableClick",{value:cleanVariable(value),target:target})}function preventDrag(e){var target=e.target;if(!isVariable(target))return null;e.preventDefault();e.stopImmediatePropagation()}var currentDirection;function keyDown(e){if(e.keyCode===8&&typedCharacters.length>0){typedCharacters=typedCharacters.slice(0,-1)}else if(e.keyCode>=65&&e.keyCode<=90||e.keyCode>=48&&e.keyCode<=57||e.keyCode===219||e.keyCode===221||e.keyCode===189){var typedChar=e.key;typedCharacters+=typedChar}if(e.keyCode==37){currentDirection="left"}else if(e.keyCode==39){currentDirection="right"}else if(e.keyCode==38){currentDirection="up"}else if(e.keyCode==40){currentDirection="down"}else if(e.keyCode==8){var r=editor.selection.getRng();if(r.collapsed&&r.startOffset>=1&&r.startContainer.textContent.charCodeAt(r.startOffset)==65279){r.startContainer.textContent=r.startContainer.textContent.slice(0,r.startOffset-1)+r.startContainer.textContent.slice(r.startOffset+1);e.preventDefault();e.stopImmediatePropagation()}}}function keyUp(){var cursorPosition=editor.selection.getRng();var variablePattern=/\[\[([^\[\]]+)\]\]/g;var matches=typedCharacters.match(variablePattern);if(matches&&matches.length>0){var newNode=matches[matches.length-1];var elements=editor.dom.select('span[data-original-variable="'+newNode+'"]');if(elements.length>0){var newNodes=elements[elements.length-1];cursorPosition.setStartAfter(newNodes);cursorPosition.collapse(true);editor.selection.setRng(cursorPosition);typedCharacters=""}}}function nodeChange(e){var target=e.element;if(!isVariable(target))return null;e.preventDefault();e.stopImmediatePropagation();switch(currentDirection){case"left":case"up":editor.selection.select(target);editor.selection.collapse(true);break;case"down":case"right":editor.selection.select(target);editor.selection.collapse();break}}editor.on("beforegetcontent",handleContentRerender);editor.on("init",stringToHTML);editor.on("getcontent",stringToHTML);editor.on("click",handleClick);editor.on("mousedown",preventDrag);editor.on("keydown",keyDown);editor.on("keyup",keyUp);editor.on("NodeChange",nodeChange);this.addVariable=addVariable});